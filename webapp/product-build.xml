<?xml version="1.0" encoding="UTF-8"?>

<!-- $This file is distributed under the terms of the license in /doc/license.txt$ -->

<!-- ====================================================================== 
     Build script for the Vivo Products.
                   
     jeb228                                                                
     ======================================================================-->
<project name="vivoProduct" default="describe">

	<!--
     This script should not be run on its own. 
     It should only be run from the build script of an individual Product.
    -->
	<fail>
		<condition>
			<equals arg1="${ant.file.vivoProduct}" arg2="${ant.file}" />
		</condition>
        This script should not be run by itself.
        It should be invoked from the build script of a Vivo product.
    </fail>

	<fail unless="inner.basedir"
	      message="The build script for the product must define a value for inner.basedir" />

	<!-- 
		The build directory goes in the product directory. 
		Everything else hangs from the build directory. 
	-->
	<property name="build.dir" location="./.build" />
	<property name="appbase.dir" location="${build.dir}/appBase" />

	<dirname property="vivoProduct.basedir" file="${ant.file.vivoProduct}" />
	<path id="anttasks.classpath">
		<pathelement location="${vivoProduct.basedir}/../utilities/anttasks/classes" />
	</path>

	<!-- - - - - - - - - - - - - - - - - - 
          custom Ant types                      
         - - - - - - - - - - - - - - - - - -->
	<typedef name="dirDifference"
	         classname="edu.cornell.mannlib.vitro.utilities.anttasks.DirDifferenceFileSet"
	         classpathref="anttasks.classpath" />

	<!-- - - - - - - - - - - - - - - - - - 
          target: prepare                      
         - - - - - - - - - - - - - - - - - -->
	<target name="prepare" depends="product-prepare,vitroCore.prepare" />

	<!-- - - - - - - - - - - - - - - - - - 
          target: product-prepare                      
         - - - - - - - - - - - - - - - - - -->
	<target name="product-prepare">
		<mkdir dir="${appbase.dir}" />
		<mkdir dir="${appbase.dir}/web" />

		<copy todir="${appbase.dir}/web" includeemptydirs="true">
			<dirDifference dir="${inner.basedir}/web">
				<blockingPath>
					<pathelement location="${product.modifications.dir}" />
				</blockingPath>
			</dirDifference>
		</copy>
		<copy todir="${appbase.dir}/web" includeemptydirs="true">
			<fileset dir="${product.modifications.dir}" />
		</copy>

		<copy todir="${appbase.dir}/config" includeemptydirs="true">
			<fileset dir="${inner.basedir}/config" />
		</copy>

		<copy todir="${appbase.dir}" includeemptydirs="true">
			<dirDifference dir="${inner.basedir}">
				<include name="src/**/*" />
				<include name="lib/**/*" />
				<include name="test/**/*" />
				<include name="themes/**/*" unless="skip.core.themes" />
				<include name="context.xml" />
				<blockingPath>
					<pathelement location="." />
				</blockingPath>
			</dirDifference>
		</copy>
		<copy todir="${appbase.dir}" includeemptydirs="true">
			<fileset dir="." erroronmissingdir="false">
				<include name="src/**/*" />
				<include name="lib/**/*" />
				<include name="test/**/*" />
				<include name="themes/**/*" />
				<include name="context.xml" />
			</fileset>
		</copy>
	</target>

	<import file="${vivoProduct.basedir}/build.xml" />

	<!-- ================================= 
	      target: revisionInfo              
	     ================================= -->
	<target name="revisionInfo"
	        depends="vitroCore.revisionInfo"
	        description="--> Store revision info in build">
		<addRevisionInfoLine productName="${ant.project.name}" productCheckoutDir="${basedir}" />
	</target>

	<!-- ================================= 
          target: licenser             
          
          In regular use, checks that all appropriate source files have license tags.
          At release time, applies license text to source files.
          
          NOTE: don't override licenser.properties.file from the command line.
          Instead, override licenser.core.properties.file and licenser.product.properties.file
         ================================= -->
	<target name="licenser" description="--> Check source files for licensing tags">
		<property name="licenser.product.properties.file"
		          location="./config/licenser/licenser.properties" />
		<property name="licenser.core.properties.file"
		          location="${corebase.dir}/config/licenser/licenser.properties" />
		<runLicenserScript productname="${ant.project.name}" propertiesfile="${licenser.product.properties.file}" />
		<runLicenserScript productname="Vitro core" propertiesfile="${licenser.core.properties.file}" />
	</target>

	<!-- 
	===========================================================================
	===========================================================================
	===========================================================================
	NOT YET USING ANYTHING BELOW HERE
	===========================================================================
	===========================================================================
	===========================================================================
	-->

	<!-- ================================= 
          target: jar              
         ================================= -->
	<target name="jar" depends="revisionInfo" description="--> Build the app and create a JAR file">
		<jar basedir="${build.dir}/war/WEB-INF/classes"
		     destfile="${build.dir}/${webapp.name}.jar" />
	</target>

</project>
